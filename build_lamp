#!/bin/bash

if [ -z $SUDO_USER ]; then
  echo "Please run the script using sudo, e.g.,"
  echo ""
  echo "sudo ./build_lamp"
  exit 1
fi

PORTFOUND=$(type -P port)
if [ "$PORTFOUND" == "" ]; then
  echo "port command not found. Please ensure that MacPorts has been installed."
  echo "Then log out, log in, and try again."
  exit 1
fi

# Update ports tree.
port selfupdate

# Remove startup items; these will be replaced.
rm /Library/LaunchDaemons/org.macports.apache2.plist
rm /Library/LaunchDaemons/org.macports.slapd.plist

# Install apache2 and friends.
port install apache2
port install php56-apache2handler
port install php56-gd php56-ldap php56-mbstring php56-mcrypt php56-mysql php56-pear php56-APC
port install php56-iconv php56-xdebug php56-openssl
port install php56-curl
port install pear-PEAR
/opt/local/apache2/bin/apxs -a -e -n php5 mod_php56.so
chown $SUDO_USER ~/.pearrc

defSock='/opt/local/var/run/mysql55/mysqld.sock'
cat /opt/local/etc/php56/php.ini-development | sed \
  -e "s#pdo_mysql\.default_socket.*#pdo_mysql\.default_socket=${defSock}#" \
  -e "s#mysql\.default_socket.*#mysql\.default_socket=${defSock}#" \
  -e "s#mysqli\.default_socket.*#mysqli\.default_socket=${defSock}#" > /opt/local/etc/php56/php.ini
echo "date.timezone = 'America/Chicago'" >> /opt/local/etc/php56/php.ini
echo "error_log = /var/log/php.log" >> /opt/local/etc/php56/php.ini

# PHP will log errors to /var/log/php.log.
touch /var/log/php.log
chown _www /var/log/php.log

cp /opt/local/etc/apache2/conf/httpd.conf /opt/local/etc/apache2/conf/httpd.conf.bak
cp /opt/local/etc/apache2/extra/httpd-vhosts.conf /opt/local/etc/apache2/extra/httpd-vhosts.conf.bak

# Websites will live in ~/Sites.
mkdir -p ~/Sites
chown -R $SUDO_USER ~/Sites

FQHN=$(hostname)
echo "127.0.0.1 local.test" >> /etc/hosts
MYIP=$(ipconfig getifaddr en0)
echo "Include etc/apache2/extra/httpd-vhosts.conf" >> /opt/local/etc/apache2/conf/httpd.conf
echo "ServerName $FQHN:80" >> /opt/local/etc/apache2/conf/httpd.conf
echo "Include etc/apache2/extra/mod_php56.conf" >> /opt/local/etc/apache2/conf/httpd.conf
echo "<VirtualHost *:80>" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "    ServerName local.test" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "    DocumentRoot "$HOME/Sites"" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "    <Directory "$HOME/Sites">" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "      Options Indexes FollowSymLinks" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "      DirectoryIndex index.php index.html" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "      Require ip 127.0.0.1 $MYIP" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "      Deny from all" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "      AllowOverride All" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "    </Directory>" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf
echo "</VirtualHost>" >> /opt/local/etc/apache2/extra/httpd-vhosts.conf

# Start Apache
sudo port load apache2

# Back up system binaries.
echo "Ignore any errors that appear below. If System Integrity Protection is"
echo "enabled (which is the default) macOS will not let us change /usr/bin."
mv /usr/bin/php /usr/bin/php.stock
mv /usr/bin/php-config /usr/bin/php-config.stock
mv /usr/bin/phpize /usr/bin/phpize.stock
echo "OK, start paying attention to errors again."

# Map php, php-config, phpize to php56.
port select php php56

echo 'te() { tail -f /opt/local/var/log/apache2/error_log; }' >> ~/.bash_profile
echo 'ta() { tail -f /opt/local/var/log/apache2/access_log; }' >> ~/.bash_profile
echo 'tp() { tail -f /var/log/php.log; }' >> ~/.bash_profile
echo "alias acr='sudo /opt/local/sbin/apachectl -k restart'" >> ~/.bash_profile
echo
echo "MySQL was not installed. To install, run separate script build_mysql."
echo "Complete. Open a new Terminal window for profile settings to take effect."
echo
echo 'Note that if MacPorts put its $PATH modification code into .profile then'
echo ".bash_profile will not be run."
echo "See http://stackoverflow.com/questions/18773051/how-to-make-os-x-to-read-bash-profile-not-profile-file"
